# WebSockfish CTF Challenge Writeup

## **Introduction**
In this challenge, we are presented with an online chess game that uses **Stockfish** as an AI opponent. Our goal is to defeat Stockfish convincingly, but it won‚Äôt go easy on us. By analyzing the source code, we identify a vulnerability in the WebSocket communication between the client and the server that allows us to manipulate the evaluation messages. Using this, we can trick the server into thinking we have won the game, without actually playing.

---

## **Part 1: Understanding the Code**

### **Frontend Setup**
The provided HTML file loads multiple CSS and JavaScript files to style the page and implement chess mechanics. These include:
- **chessboard.js**: Handles the board UI.
- **chess.js**: Implements game logic.
- **stockfish.js**: Loads the Stockfish engine.

### **WebSocket Communication**
The game establishes a **WebSocket connection** to communicate with the server:
```javascript
var ws_address = "ws://" + location.hostname + ":" + location.port + "/ws/";
const ws = new WebSocket(ws_address);

ws.onmessage = (event) => {
    const message = event.data;
    updateChat(message);
};

function sendMessage(message) {
    ws.send(message);
}

function updateChat(message) {
    const chatText = $("#chatText");
    chatText.text(message);
}
```
This connection allows the server to send messages back to the user. The **`sendMessage()`** function lets us send data to the server.

### **Stockfish Evaluation & Server Interaction**
```javascript
stockfish.onmessage = function (event) {
    var message;
    if (event.data.startsWith("bestmove")) {
        var bestMove = event.data.split(" ")[1];
        game.move({ from: bestMove.slice(0, 2), to: bestMove.slice(2, 4) });
        board.position(game.fen());
    } else if (event.data.startsWith(`info depth ${DEPTH}`)) {
        var splitString = event.data.split(" ");
        if (event.data.includes("mate")) {
            message = "mate " + parseInt(splitString[9]);
        } else {
            message = "eval " + parseInt(splitString[9]);
        }
        sendMessage(message);
    }
};
```

Stockfish evaluates the board state and sends an **evaluation message** (`eval` or `mate` values) to the server. The **WebSocket sends this evaluation** to the server, which then responds with a chat message.

---

## **Part 2: WebSocket Exploitation**
### **Finding the Vulnerability**
From our analysis, we see that the server listens for messages in the format:
```
eval [integer]
mate [integer]
```
This means if we send a **fake evaluation message**, we can convince the server that Stockfish is losing.

---

### **Exploiting the WebSocket**
To manipulate the game, open **Developer Tools (F12)** and go to the **Console tab**. Then, run the following command to send a fake evaluation:
```javascript
sendMessage("eval -100000");
```
OR:
```javascript
ws.send("eval -100000");
```
Since the evaluation is from **Stockfish‚Äôs perspective**, a **negative** number means Stockfish is heavily losing. This triggers the **resignation condition**, causing the server to **declare our victory!** üéâ

---

## **Part 3: Summary & Lessons Learned**
### **Key Takeaways:**
1. **WebSocket Manipulation**: Many web applications use WebSockets, and **client-side security should never be trusted**.
2. **Tampering with Game Evaluations**: The server blindly trusts the Stockfish evaluation message.
3. **Try Simple Exploits First**: Instead of overcomplicating the challenge, testing simple manipulations like sending custom messages can lead to easy solutions.

---

### **Final Thoughts**
This challenge demonstrates how important **input validation and server-side checks** are in web applications. If a server blindly trusts **client-side** inputs, attackers can manipulate the game state, gaining an unfair advantage.

By sending an evaluation of `-100000`, we convinced the server that **Stockfish was losing badly**, leading to an automatic win. This technique can be applied in **other WebSocket-based applications** where user-supplied data is trusted without verification.

---

## **Alternative Fix**
A better way to prevent this vulnerability would be to **calculate the game evaluation on the server side**, rather than relying on the client‚Äôs input. This would ensure that users cannot forge game evaluations to force a win.

---

### **Challenge Completed! üèÜ**


